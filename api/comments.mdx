---
title: "Comments API"
description: "Add conversations to feedback with threaded replies, reactions, and official responses."
icon: "message-circle"
---

# Comments API

Turn feedback into conversations. The Comments API lets you create threaded discussions, add emoji reactions, and pin official team responses to keep users informed.

## Overview

Comments support nested replies, emoji reactions, and the ability to pin team responses as the "official answer" to a post. Team member comments are automatically badged to distinguish them from community feedback.

## Authentication

- **Creating comments:** Requires any authenticated user (`admin`, `member`, or `user` role)
- **Editing/deleting comments:** Authors can edit/delete their own comments (with restrictions); team members can edit/delete any comment
- **Reactions:** Requires any authenticated user
- **Pinning comments:** Requires `admin` or `member` role

## Create comments

### Create Comment

Create a new comment on a post. Supports nested replies via `parentId`.

**Function:** `createCommentFn`

**Method:** `POST`

**Authentication:** Any authenticated user

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `postId` | `string` | Yes | Post ID to comment on |
| `content` | `string` | Yes | Comment text (1-5,000 chars) |
| `parentId` | `string` | No | Parent comment ID for replies |

**Response:**

```typescript
{
  comment: {
    id: string               // Comment ID (TypeID format: comment_xxx)
    postId: string
    content: string
    parentId: string | null
    memberId: string | null
    authorName: string | null
    authorEmail: string | null
    isTeamMember: boolean
    createdAt: Date
  }
  post: {
    id: string
    title: string
    boardSlug: string
  }
}
```

**Example:**

```typescript
import { createCommentFn } from '@/lib/server-functions/comments'

// Create a root-level comment
const result = await createCommentFn({
  data: {
    postId: 'post_01h455vb4pex5vsknk084sn02q',
    content: 'This is a great suggestion! We should definitely consider this.',
  },
})

console.log('Created comment:', result.comment.id)
```

**Creating a Reply:**

```typescript
// Reply to an existing comment
const reply = await createCommentFn({
  data: {
    postId: 'post_01h455vb4pex5vsknk084sn02q',
    content: 'Thanks for the feedback!',
    parentId: 'comment_01h455vb4pex5vsknk084sn02q', // Parent comment
  },
})
```

<Tip>
**Side Effects:**

- Author is automatically subscribed to the post for notifications
- `comment.created` event is dispatched (for integrations like Slack)
</Tip>

## Update comments

### Update Comment (Admin)

Update a comment as a team member.

**Function:** `updateCommentFn`

**Method:** `POST`

**Authentication:** `admin` or `member` role required (or comment author)

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | `string` | Yes | Comment ID to update |
| `content` | `string` | Yes | New content (1-5,000 chars) |

**Example:**

```typescript
import { updateCommentFn } from '@/lib/server-functions/comments'

const updated = await updateCommentFn({
  data: {
    id: 'comment_01h455vb4pex5vsknk084sn02q',
    content: 'Updated: This feature is now planned for Q2!',
  },
})
```

### User Edit Comment

Allow users to edit their own comments from the portal.

**Function:** `userEditCommentFn`

**Method:** `POST`

**Authentication:** Comment author required

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `commentId` | `string` | Yes | Comment ID to edit |
| `content` | `string` | Yes | New content |

<Note>
**Edit Restrictions:**

Users can only edit their own comments when:
- The comment has not been deleted
- No team member has replied to the comment

Team members can always edit any comment.
</Note>

**Example:**

```typescript
import { userEditCommentFn } from '@/lib/server-functions/comments'

const updated = await userEditCommentFn({
  data: {
    commentId: 'comment_01h455vb4pex5vsknk084sn02q',
    content: 'Updated my original comment with more details.',
  },
})
```

## Delete comments

### Delete Comment (Admin)

Hard delete a comment. This permanently removes the comment and all its data.

**Function:** `deleteCommentFn`

**Method:** `POST`

**Authentication:** `admin` or `member` role required (or comment author)

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | `string` | Yes | Comment ID to delete |

<Warning>
Deleting a comment will cascade delete all replies due to database constraints.
</Warning>

### User Delete Comment

Soft delete a comment from the portal. The comment shows a placeholder in the thread.

**Function:** `userDeleteCommentFn`

**Method:** `POST`

**Authentication:** Comment author required

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `commentId` | `string` | Yes | Comment ID to delete |

<Note>
**Delete Restrictions:**

Users can only delete their own comments when:
- The comment has not already been deleted
- No team member has replied to the comment
</Note>

**Example:**

```typescript
import { userDeleteCommentFn } from '@/lib/server-functions/comments'

const result = await userDeleteCommentFn({
  data: {
    commentId: 'comment_01h455vb4pex5vsknk084sn02q',
  },
})

console.log('Deleted comment:', result.id)
```

## Reactions

### Toggle Reaction

Add or remove an emoji reaction on a comment. If the user has already reacted with the same emoji, the reaction is removed.

**Function:** `toggleReactionFn`

**Method:** `POST`

**Authentication:** Any authenticated user

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `commentId` | `string` | Yes | Comment ID to react to |
| `emoji` | `string` | Yes | Emoji character or shortcode |

**Response:**

```typescript
{
  added: boolean  // true if reaction was added, false if removed
  reactions: Array<{
    emoji: string
    count: number
    hasReacted: boolean  // Whether current user has this reaction
  }>
}
```

**Example:**

```typescript
import { toggleReactionFn } from '@/lib/server-functions/comments'

const result = await toggleReactionFn({
  data: {
    commentId: 'comment_01h455vb4pex5vsknk084sn02q',
    emoji: 'üëç',
  },
})

if (result.added) {
  console.log('Reaction added!')
} else {
  console.log('Reaction removed!')
}

console.log('Updated reactions:', result.reactions)
// [{ emoji: 'üëç', count: 5, hasReacted: true }]
```

## Pin comments (official response)

Team members can pin a comment as the "official response" to a post. This highlights the comment at the top of the discussion.

### Check if Comment Can Be Pinned

**Function:** `canPinCommentFn`

**Method:** `GET`

**Authentication:** Optional

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `commentId` | `string` | Yes | Comment ID to check |

**Response:**

```typescript
{
  canPin: boolean
  reason?: string  // Explanation if canPin is false
}
```

<Note>
**Pin Requirements:**

- Comment must exist and not be deleted
- Comment must be a root-level comment (no `parentId`)
- Comment must be from a team member (`isTeamMember = true`)
</Note>

### Pin Comment

Set a comment as the official response for its post.

**Function:** `pinCommentFn`

**Method:** `POST`

**Authentication:** `admin` or `member` role required

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `commentId` | `string` | Yes | Comment ID to pin |

**Response:**

```typescript
{
  postId: string  // The post this comment belongs to
}
```

**Example:**

```typescript
import { pinCommentFn, canPinCommentFn } from '@/lib/server-functions/comments'

// First check if the comment can be pinned
const { canPin, reason } = await canPinCommentFn({
  data: { commentId: 'comment_01h455vb4pex5vsknk084sn02q' },
})

if (!canPin) {
  console.error('Cannot pin:', reason)
  return
}

// Pin the comment
const result = await pinCommentFn({
  data: { commentId: 'comment_01h455vb4pex5vsknk084sn02q' },
})

console.log('Pinned comment on post:', result.postId)
```

### Unpin Comment

Remove the pinned comment from a post.

**Function:** `unpinCommentFn`

**Method:** `POST`

**Authentication:** `admin` or `member` role required

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `postId` | `string` | Yes | Post ID to unpin comment from |

**Example:**

```typescript
import { unpinCommentFn } from '@/lib/server-functions/comments'

await unpinCommentFn({
  data: { postId: 'post_01h455vb4pex5vsknk084sn02q' },
})
```

<Tip>
If a pinned comment is soft-deleted, it is automatically unpinned.
</Tip>

## Permissions

### Get Comment Permissions

Check if the current user can edit or delete a comment.

**Function:** `getCommentPermissionsFn`

**Method:** `GET`

**Authentication:** Optional

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `commentId` | `string` | Yes | Comment ID to check |

**Response:**

```typescript
{
  canEdit: boolean
  canDelete: boolean
}
```

**Example:**

```typescript
import { getCommentPermissionsFn } from '@/lib/server-functions/comments'

const permissions = await getCommentPermissionsFn({
  data: { commentId: 'comment_01h455vb4pex5vsknk084sn02q' },
})

if (permissions.canEdit) {
  // Show edit button
}

if (permissions.canDelete) {
  // Show delete button
}
```

## Comment Threading

Comments are returned as a threaded tree structure where replies are nested under their parent comments.

**Example Response Structure:**

```typescript
{
  comments: [
    {
      id: 'comment_1',
      content: 'This is a great idea!',
      parentId: null,
      isTeamMember: false,
      authorName: 'Alice',
      createdAt: '2024-01-15T10:00:00Z',
      reactions: [
        { emoji: 'üëç', count: 3, hasReacted: false },
        { emoji: '‚ù§Ô∏è', count: 1, hasReacted: true },
      ],
      replies: [
        {
          id: 'comment_2',
          content: 'Thanks for the feedback!',
          parentId: 'comment_1',
          isTeamMember: true,
          authorName: 'Bob (Team)',
          createdAt: '2024-01-15T11:00:00Z',
          reactions: [],
          replies: [
            {
              id: 'comment_3',
              content: 'Any timeline on this?',
              parentId: 'comment_2',
              // ... nested replies continue
            }
          ]
        }
      ]
    }
  ]
}
```

## Team Member Badge

<Tip>
Comments from team members (users with `admin` or `member` role) have `isTeamMember: true`. This is typically displayed as a badge in the UI to distinguish official team responses from community comments.
</Tip>

## Error Handling

All server functions throw typed errors:

```typescript
import { NotFoundError, ValidationError, ForbiddenError } from '@/lib/shared/errors'

try {
  await createCommentFn({
    data: {
      postId: 'invalid_id',
      content: 'Test comment',
    },
  })
} catch (error) {
  if (error instanceof NotFoundError) {
    // Post not found
    console.error('Post not found:', error.message)
  } else if (error instanceof ValidationError) {
    // Invalid input (e.g., content too long)
    console.error('Invalid input:', error.message)
  } else if (error instanceof ForbiddenError) {
    // Not authorized (e.g., trying to edit someone else's comment)
    console.error('Not authorized:', error.message)
  }
}
```

## Input Validation

| Field | Validation |
|-------|------------|
| `content` | Required, 1-5,000 characters |
| `postId` | Must exist and belong to a valid board |
| `parentId` | Must exist and belong to the same post (if provided) |
| `emoji` | Must be a valid emoji string |

<Tip>
## TypeID Format

Comment IDs use TypeID format: `comment_01h455vb4pex5vsknk084sn02q`

This provides type safety and makes IDs self-documenting in logs and databases.
</Tip>
